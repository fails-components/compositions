global
    log          fd@2 local2
#    log stdout  format raw  local0  info
    master-worker



resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry   1s
    hold other      10s
    hold refused    10s
    hold nx         10s
    hold timeout    10s
    hold valid      10s
    hold obsolete   10s

defaults
    log global
    retries 3
    option  redispatch
    timeout client 30s
    timeout connect 4s
    timeout server 30s
    mode http
    option httplog

frontend fails
   bind :80
 #  bind :443 ssl crt /data/sslconf/cert.pem
 #  http-request redirect scheme https unless { ssl_fc }
 # makes no sense just for debugging
  # default_backend ltihandler
  # if "/lti"
   use_backend ltihandler if { path_beg /lti/ }
   use_backend apphandler if { path_beg /app/ }
   use_backend notepadhandler if { path_beg /notepad.io/ }
   use_backend noteshandler if { path_beg /notes.io/ }
   use_backend staticserver if { path_beg /static/ }
   use_backend staticserver if { path_beg /files/ }
   use_backend stat if { path -i /proxy-stats }

backend ltihandler
    option forwardfor
    balance leastconn
#    option httpchk HEAD /lti/launch HTTP/1.0
#    server ltihandler ltihandler:8080 check fall 1 rise 2
    server-template ltihandler- 10 ltihandler:8080 check resolvers docker init-addr libc,none

backend apphandler
    option forwardfor
    balance leastconn
#    option httpchk HEAD /lti/launch HTTP/1.0
#    server ltihandler apphandler:8080 check fall 1 rise 2
    server-template apphandler- 10 apphandler:8080 check resolvers docker init-addr libc,none

backend notepadhandler
#    option httpchk HEAD /health
    balance leastconn
#    http-check expect status 200
    cookie io prefix dynamic nocache # using the `io` cookie set upon handshake
    dynamic-cookie-key  "${FAILS_COOKIE_KEY}" 
    server-template notepadhandler- 10 notepadhandler:8080 check resolvers docker init-addr libc,none 
     
backend noteshandler
#    option httpchk HEAD /health
    balance leastconn
#    http-check expect status 200
    cookie io prefix dynamic nocache # using the `io` cookie set upon handshake
    dynamic-cookie-key  "${FAILS_COOKIE_KEY}" 
    server-template noteshandler- 10 noteshandler:8080 check resolvers docker init-addr libc,none 
     
        


backend staticserver
    option forwardfor
    balance leastconn
#    option httpchk HEAD /lti/launch HTTP/1.0
#    server ltihandler ltihandler:8080 check fall 1 rise 2
    server-template staticserver- 10 staticserver:80 check resolvers docker init-addr libc,none

backend stat
    stats enable
    stats uri /proxy-stats
    stats refresh 15s
    stats show-legends
    stats show-node

